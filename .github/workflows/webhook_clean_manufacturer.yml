name: Manual Manufacturer Cleanup
run-name: "Clean manufacturer | ids: ${{ github.event.inputs.asset_base_ids || github.event.client_payload.asset_base_ids || 'bulk' }} | count: ${{ github.event.inputs.max_assets || github.event.client_payload.max_assets || 'auto' }}"

on:
  workflow_dispatch:
    inputs:
      asset_base_ids:
        description: 'Comma- or newline-separated asset base IDs (optional)'
        required: false
      max_assets:
        description: 'Number of assets to process when IDs are not provided (no upper cap)'
        required: false
        default: '2000'
      skip_update:
        description: 'Set to true to dry-run without patching assets'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [clean-manufacturer-tags]

env:
  BLENDERKIT_SERVER: "https://www.blenderkit.com"
  BLENDERKIT_API_KEY: ${{ secrets.BLENDERKIT_API_KEY }}
  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  prepare:
    name: Prepare inputs
    runs-on: ubuntu-latest
    outputs:
      asset_ids_json: ${{ steps.normalize_ids.outputs.asset_ids_json }}
      asset_count: ${{ steps.normalize_count.outputs.asset_count }}
      skip_update: ${{ steps.skip_update.outputs.skip_update }}
    steps:
      - id: normalize_ids
        name: Normalize asset IDs
        shell: bash
        env:
          IDS_INPUT: ${{ github.event.inputs.asset_base_ids || github.event.client_payload.asset_base_ids }}
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os, re

          raw_ids = os.environ.get("IDS_INPUT", "") or ""
          tokens = [part.strip() for part in re.split(r"[,\s]+", raw_ids) if part.strip()]
          unique_ids = list(dict.fromkeys(tokens))
          print(f"asset_ids_json={json.dumps(unique_ids)}")
          PY

      - id: normalize_count
        name: Determine asset count
        shell: bash
        env:
          COUNT_INPUT: ${{ github.event.inputs.max_assets || github.event.client_payload.max_assets }}
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import os

          raw = (os.environ.get("COUNT_INPUT") or "").strip()
          try:
              count = int(raw)
          except ValueError:
              count = 0
          if count <= 0:
              count = 2000
          print(f"asset_count={count}")
          PY

      - id: skip_update
        name: Determine skip update flag
        run: echo "skip_update=${{ github.event.inputs.skip_update || github.event.client_payload.skip_update || false }}" >> "$GITHUB_OUTPUT"

  clean-by-id:
    name: Clean manufacturer tags (IDs)
    needs: prepare
    if: needs.prepare.outputs.asset_ids_json != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        asset_id: ${{ fromJSON(needs.prepare.outputs.asset_ids_json) }}
      max-parallel: 6
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      SKIP_UPDATE: ${{ needs.prepare.outputs.skip_update }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ai.txt
      - name: Clean manufacturer tags for ${{ matrix.asset_id }}
        env:
          ASSET_BASE_ID: ${{ matrix.asset_id }}
        run: python clean_manufacturer_tags.py

  clean-bulk:
    name: Clean manufacturer tags (bulk)
    needs: prepare
    if: needs.prepare.outputs.asset_ids_json == '[]'
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      SKIP_UPDATE: ${{ needs.prepare.outputs.skip_update }}
      MAX_ASSET_COUNT: ${{ needs.prepare.outputs.asset_count }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ai.txt
      - name: Clean manufacturer tags
        run: python clean_manufacturer_tags.py
